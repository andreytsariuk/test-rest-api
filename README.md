
# Test REST API project


The following software shall be installed:

* **[NodeJS](http://nodejs.org)** v. 10.x
* **[PostgreSQL](http://www.postgresql.org)** v. 10.x
* **[eslint](https://www.npmjs.com/package/eslint)** v.5.16.0 


## NPM scripts
All script placed in **[package.json](./package.json)**

* ```npm install``` - install all dependencies and creates an .develop.env for local development with Composer
* ```npm run build``` - lint a code and make build if needed
* ```npm version [patch|minor|major]``` - create a commit with git-tag to update a version 
* ```npm start``` - run application on any environment
* ```npm run lint``` - runs a eslint linter from node_modules with local **[.eslintrc.js](./.eslintrc.js)**
* ```npm test``` - will run all existing tests. Unit tests + integration tests
* ```npm run integration-tests``` - will run all existing tests only integration tests with placing all created coverage data in **[coverage](./coverage)** folder
* ```npm run unit-tests``` - will run only unit tests and shows coverage for used files



## Git Hooks

### pre-commit
Before each **commit** will runs linter with basic unit test to check code works.

### pre-push
Before each **push** will run linter and full set of Tests: Unit + Integration + Coverage generation



## Environment

#### ENV variables:
* DB_CONNECTION_URL - "postgres://[user_name]:[password]@localhost/[db_name]"
* JWT_SECRET - secret for JWT. can be any string
* AWS_ACCESS_KEY_ID - Specifies an AWS access key associated with an IAM user or role.
* AWS_SECRET_ACCESS_KEY - Specifies the secret key associated with the access key. This is essentially the "password" for the access key.
* AWS_SES_REGION - The region Of AWS **SES**
* AWS_SQS_NOTIFICATION_QUEUE - the queue to send notification to proceed on Notification Service (AWS Lambda)
* ES_CONNECTION_STRING - connection string to ES
* ES_LOG - Default tpo error but could be a 'trace'
* ES_REQUEST_TIMEOUT - the timeout of the request to ES 
* ES_API_VERSION - the ES api version  
* ES_INDEX_PREFIX - the prefix of logging (for Winston)
* ES_INDEX_SUFFIX_PATTERN - the pattern of ES suffix. [YYYY.MM.DD] a **[Moment.js](https://momentjs.com/)** compatible date/ time pattern


#### [Config file](./config/default.json) :
* serverUrl - server location. In current version (v 2.0.0) Uses to render pictures in Email notifications. 
* WebUrl - application FE location. Uses to redirect via Email notifications. 
* JWT.Secret - just for develop. Uses to provide secret of JWT
* JWT.ExpirationCount - number of time units within expiration will happens
* JWT.ExpirationCountItem - time unit one of \['h','m','d'\]
* Support.senderEmail - E-mail address that is a sender in Email notifications.
* Db.* - Standard **[Knex](http://knexjs.org)** config.
* TokenTypes.* - describers token types and names in the system. Uses like a constant.


## API

### Coverage
* /coverage - Test coverage for integration Tests. generated by **[nyc](https://www.npmjs.com/package/nyc)** 
### Versioning
* /public/version - Api return current Application Version


## Database

### **[Knex](./db/docs/testER.png)**

### General
For local development, the following DB is used by default:
```
Database: test
Host: localhost
User: test
Password: test
```

So the conneciton string looks like the following:
```
postgres://test:test@localhost/test
```

To create empty database, with default values,  can be used:
```
knex migrate:latest
knex seed:run
```

### Docker-Composer 

first of all provide your path to DB like an env variable.
```
export DB_CONNECTION_URL=postgres://test:test@localhost/test
```

after that from the *api* folder run the next command for migrations:
```
knex migrate:latest
``` 

an the next command for *seeds*:
```
knex seed:run

```


## Running

To start server for just user the following command: 
```
npm start
```